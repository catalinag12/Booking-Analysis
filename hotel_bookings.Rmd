---
title: "Hotel Booking Analysis"
author: "Maftei Alexandru, Vasile Catalina"
output: slidy_presentation
---


### Introduction
The dataset contains information on bookings in two types of hotels, both located in Portugal,a resort hotel and a city hotel. Each observation represents a hotel reservation. The data set includes reservations between July 1, 2015 and August 31, 2017, including those canceled. Because it is the actual data of the hotel, all information regarding the identification of the hotel or the client has been deleted. Due to the lack of real business data for scientific and educational purposes, these data sets can play an important role for research and education in revenue management, machine learning or data mining, as well as in other fields.

Every year, more than 140 million bookings were made on the Internet and hotel booking cancellations is a growing problem. An analysis of the last 5 years showed that the cancellation rate on booking has reached almost 40% and this trend produces a very negative impact on hotels revenue and distribution management strategies.

So, it is useful to try to understand and even predict which guests are more likely to cancel their bookings by getting insights from the data set and discovering which features have contributed more to cancellations.



### The dataset
+ hotel : resort or city
+ is_canceled: canceled=1, not canceled=0
+ arrival_date_year
+ arrival_date_month
+ arrival_date_month : between 1 and 53
+ arrival_date_day_of_month
+ stays_in_weekend_nights
+ stays_in_week_nights
+ adults
+ children
+ babies
+ meal: undefined(no package), BB, HB, FB
+ country
+ market_segment : TA=travel agents, TO=tour operators
+ distribution_channel : TA or TO
+ is_repeated_guest: yes=1, no=0
+ previous_cancellations
+ previous_bookings_not_canceled
+ reserved_room_type
+ assigned_room_type
+ booking_changes
+ deposit_type: no deposit, non refund or refundable
+ agent
+ company
+ day_in_waiting_list
+ customer_type
+ adr (average daily rate) =sum of all transactions/no of nights
+ required_car_parking_spaces
+ total_of_special_requests
+ reservation_status: canceled, check-out, no-show
+ reservation_status_date

### Preparation of the data set
```{r, warning=FALSE}
data<-read.csv('C:/Users/catal/OneDrive/Desktop/hotel_bookings.csv', header= TRUE)
mydataset<-read.csv('C:/Users/catal/OneDrive/Desktop/hotel_bookings.csv', header= TRUE)
#delete missing values
sum(is.na(mydataset))
#4 missing values in the column childer, so we'll replace them with values from column babies
n <- length(mydataset$children)
for (i in 1:n) {
  if (is.na(mydataset$children[i]))
    mydataset$children[i] <- mydataset$babies[i]
}


#verify again if the missing values were omitted
sum(is.na(mydataset))

rownames(mydataset)<-mydataset$name
mydataset$name=NULL
str(mydataset)
```


### Exploratory Data Analysis
* perform initial investigations on data in order to discover patterns, anomalies with the help of summary statistics and graphical representations

We will try to answer to questions such as:

+ Which month is the most occupied?
+ Which month has the greates number of canceled bookings?
+ Which hotel has a greater number of cancelations?
+ Has the deposit type any effect on the cancelations?
+ From which country most tourists come?
+ Which is the most booked accommodation type?
+ How does the ADR vary over year?

We will also try to find different relationships between the attributes.

### Graphics

```{r,warning=FALSE}
countries<-as.data.frame(table(mydataset$country))
data <- data.frame(
  group=countries["Var1"],
  value=countries["Freq"]
)

install.packages("ggplot2",repos = "http://cran.us.r-project.org")
library(ggplot2)

ggplot(data, aes(x="", y=Freq, fill=Var1)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+ 
  geom_text(aes(y = Freq, label = Var1), color = "white") + 
  theme(legend.position="none")
```

People from almost the entire world choose to spend their holiday in these two hotels. The majority is of course, from Portugal, and also from european countries, such as Great Britain and France.



```{r,warning=FALSE}
ggplot(data = mydataset,aes(is_canceled))+ geom_histogram(binwidth = 0.5, col='black', fill='blue', alpha = 0.4) + facet_wrap(~hotel)
```

Most of the cancellations are made at city hotels.



```{r,warning=FALSE}

install.packages("dplyr",repos = "http://cran.us.r-project.org")   
library(magrittr)
library(dplyr)
mydataset%>%count(hotel)%>%ggplot(aes(hotel,n)) + geom_bar(stat = 'identity', fill = 'blue', alpha = 0.4, col = "black") +
  xlab('Hotels ') + ylab('Frequency')
```

However, clients still prefer city hotels instead of resorts.


```{r,warning=FALSE}
table(mydataset$hotel)


table(mydataset$is_canceled, mydataset$hotel)
```



```{r,warning=FALSE}
mydataset%>%group_by(arrival_date_month)%>%summarise(Count = n())%>%arrange(-Count)%>%ggplot(aes(x = arrival_date_month, y = Count)) +
  geom_bar(stat = 'identity',fill = "dodgerblue") + coord_flip() + geom_text(aes(x =arrival_date_month, y=0.02, label= Count),
                                                                             hjust=-1, vjust=0, size=4, 
                                                                             colour="black", fontface="bold",
                                                                             angle=360)
```

The most popular month is august, followed by july, and the least popular for travelling is january.

```{r,warning=FALSE}
mydataset %>% group_by(mydataset$arrival_date_month)  %>% summarise(length(is_canceled))
```

July and august are also the months with the greatest number of cancellations.

```{r,warning=FALSE}
mydataset %>% group_by(mydataset$adults)  %>% summarise(length(is_canceled))

```

Couples are more likely to cancel their bookings.


```{r}

ggplot(mydataset, aes((arrival_date_month), fill = factor(is_canceled))) +
  geom_bar() + geom_text(stat = "count", aes(label = ..count..), hjust = 1) +
  coord_flip() + scale_fill_discrete(
    name = "Status",
    breaks = c("0", "1"),
    label = c("Canceled", "Confirmed")
  ) +
  labs(title = "Status of the booking depending on month",
       x = "Month",
       y = "Number") + theme_bw()
```

 

```{r,warning=FALSE}
ggplot(mydataset, aes(customer_type, fill = hotel)) + 
  geom_bar(stat = "count", position = position_dodge()) + 
  labs(title = "Customer preferences",
       x = "Customer type",
       y = "Number") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        panel.background = element_blank())
```



```{r,warning=FALSE}
mydataset %>% group_by(mydataset$market_segment)  %>% summarise(length(is_canceled)) 
```
The online segment has the greatest number of cancellations.


```{r,warning=FALSE}

mydataset %>% group_by(mydataset$reserved_room_type)  %>% summarise(length(is_canceled)) 
```
Room of type A has the greatest number of cancellations.

### EDA conclusions ###

* the most popular month is July, followed by August and the least popular is January
* guests prefer the city hotel rather than the resort hotel
* obviously, city hotel has more cancelled bookings than the resort hotel
* the bookings were mostly made by european tourists, especially from Portugal
* the preffered meal is Bed&Breakfast
* only 3% are repetead guests
* the highest adr is in August
* the majority of the bookings are made by online travel agents
* bookings with a lead time more than 100 days have more chances of being cancelled
* the bookings with less special requests are more likely to be cancelled
* for resort, adr is more expensive during July, August and September, while for city hotel, adr is slightly higher in March, April and May.
* the bookings with no deposit are more likely to be cancelled


### Logistic regression ###

+ technique of regression analysis
+ the dependent variable is binary, it has the values 0 or 1, so we have a binomial regression
+ we analyze the dependent categorical variable with the help of the independent variables
+ we keep as independent variables the most representatives ones for the model
+ the model of the logistic regression is similar tot the one of a linear regression, with the exception of the coefficients that vary
+ it measures the relationship between the dependent categorical variable and many independent variables by estimating probabilities using a logistic function
+ it models the probability that a booking might be cancelled or not

We will start by computing the correlations between each pair of numerical variables. These correlations will be represented in a correlation matrixt in order to have an idea of what variables are changing together.

```{r, warning=FALSE}

install.packages('corrplot',repos = "http://cran.us.r-project.org")
library(corrplot)
correlations <-cor(mydataset[,c('is_canceled','days_in_waiting_list','required_car_parking_spaces','is_repeated_guest','previous_bookings_not_canceled','booking_changes','previous_cancellations','lead_time','total_of_special_requests','adr','stays_in_week_nights','stays_in_weekend_nights','adults','children','babies')],method = c("pearson"))
correlations
corrplot(correlations, method="circle")


```

The blue points suggest a positive correlation, while the red ones suggest a negative one. The bigger the point, the stronger the correlation.

```{r, warning=FALSE}
##correlation matrix as heatmap

col<- colorRampPalette(c("red", "white", "blue"))(20)
heatmap(correlations, col=col, symm=TRUE)

```


We can observe some correlations between variables, both negative and positive, but very weak. 

In order to build the model of logistic regression we will use the glm function.
The response is represented by is_canceled and the predictors are represented by some independent variables.

We clearly specify that we want a logistic regression by setting the attribute family as "binomial".


```{r, warning=FALSE}

logistic_model <- glm(is_canceled ~ lead_time +customer_type + hotel +
                      deposit_type + adr +total_of_special_requests, data = mydataset , family = "binomial")

summary(logistic_model)
```
Summary returns the standard errors, z-score, estimations and p-values for each of the coefficients. According to the results, all coefficients, with one exception, are meaningful.

The next step is to make predictions.


```{r, warning=FALSE}
mydataset$predict<-predict(logistic_model,type="response")
mydataset$predict[1:6]
```

We will get an array of probabilities. The first two probabilities are bigger, measuring aproximatively 50% and 88%.
We will compute the accuracy of the model and try to predict whether the bookings will be canceled or not, based on the variables chosen as predictors.
In order to do this, we will use the ifelse command and as a threshold we will compute a mean.

Vom obtine un vector de probabilitati. Primele doua probabilitati sunt mai mari, masurand aproximativ 50% si respectiv 88%.


```{r}
p=mean(mydataset$is_canceled)
p

 mydataset$predictions<-ifelse(mydataset$predict >p,1,0)
```

+ mydataset predictions is an array of true and false values. If mydataset predict is higher than p, mydataset predictions takes value 1, otherwise, takes value 0.


![Confusion matrix](https://miro.medium.com/max/712/1*Z54JgbS4DUwWSknhDCvNTQ.png)

TP=true positive
TN=true negative
FP=false positive
FN=false negative 

```{r}
table(mydataset$predictions,mydataset$is_canceled)
mean(mydataset$is_canceled == mydataset$predictions)
```
The accuracy of the model is almost 75%.
According to the confusion matrix, the model predicted correctly that 62233 bookings won't be canceled, but classified wrong 17077 bookings.
By analogy, the model predicted wrong 12933 bookings and classified correctly 27147 bookings as being cancelled.

As a last step, we will analyse two parameters, AUC and ROC, which are used to assess the performance of the classification model.
AUC= area under curve
ROC= receiver operating characteristics

AUC can tell us whether the model is able to distinguish between the classes. The higher it is, the better the model will predict if the result will be 1 or 0.

```{r, warning=FALSE}

install.packages("pROC",repos = "http://cran.us.r-project.org")
library(pROC)

ROC <- roc(mydataset$is_canceled , mydataset$predictions)
plot(ROC, col = 'blue', main = "ROC curve to hotel booking model")
```

The area under the ROC curve is AUC and is computed as this: 
```{r, warning=FALSE}
auc(ROC)
```
AUC has a value close to 1, so we can say that we have a good prediction model.


### Conclusions and recommendations ###

* a model for booking cancellations can help in the identification of the likelihood of a booking being cancelled
* gives the hotel managers the opportunity to take measures and avoid possible cancellations
* the most important variables that help in prediction are: lead time, adr, deposit type, arrival day of the month, total number of special requests
* some possible measures would be:
  - setting non-refundable rates
  - collecting deposits
  - implement more efficient cancellation policies
  - offer special discounts
  - improve customer service by looking athe the number of special requests


