---
output: html_document
---

### Regresie logistica ###

+ tehnica de analiza a regresiei
+ variabila dependenta este binara, luand valorile 0 sau 1 (is_canceled), asadar regresia noastra este binomiala
+ analizam variabila dependenta categorica cu ajutorul unor variabile independente
+ pastram ca variabile independente atributele cele mai reprezentative pentru model
+ modelul regresiei logistice este similar cu cel al regresiei liniare, cu exceptia faptului ca variaza coeficientii.
+ masoara relatia dintre variabila categorica dependenta si mai multe variabile independente prin estimarea probabilitatilor folosind o functie logistica
+ modeleaza probabilitatea ca o rezervare sa fie anulata sau nu


Vom incepe prin a calcula corelatiile intre fiecare pereche de variabile numerice. Aceste corelatii vor fi reprezentate intr-o matrice de corelatie pentru a dat o idee despre ce variabile se schimba impreuna.
```{r}
data<-read.csv('C:/Users/catal/OneDrive/Desktop/hotel_bookings.csv', header= TRUE)
mydataset<-read.csv('C:/Users/catal/OneDrive/Desktop/hotel_bookings.csv', header= TRUE)
#delete missing values
sum(is.na(mydataset))
#4 missing values in the column childer, so we'll replace them with values from column babies
n <- length(mydataset$children)
for (i in 1:n) {
  if (is.na(mydataset$children[i]))
    mydataset$children[i] <- mydataset$babies[i]
}


#verify again if the missing values were omitted
sum(is.na(mydataset))

rownames(mydataset)<-mydataset$name
mydataset$name=NULL
str(mydataset)
```
```{r}
install.packages('corrplot',repos = "http://cran.us.r-project.org")
library(corrplot)
correlations <-cor(mydataset[,c('is_canceled','days_in_waiting_list','required_car_parking_spaces','is_repeated_guest','previous_bookings_not_canceled','booking_changes','previous_cancellations','lead_time','total_of_special_requests','adr','stays_in_week_nights','stays_in_weekend_nights','adults','children','babies')],method = c("pearson"))

corrplot(correlations, method="circle")

```

Punctele albastre sugereaza corelatie pozitiva, iar cele rosii corelatie negativa. Cu cat punctul este mai mare, cu atat este mai puternica si corelatia. 

Se pot observa cateva corelatii intre variabile, atat negative, cat si pozitive, dar foarte slabe. 

Pentru a construi modelul de regresie logistica vom utiliza functia glm. Raspunsul este reprezentat de is_canceled, iar predictorii sunt reprezentati de cateva variabile independente reprezentative. 

Specificam clar ca vrem sa facem un model de regresie logistica prin atributul family care este declarat ca fiind "binomial".

```{r}

logistic_model <- glm(is_canceled ~ lead_time +customer_type + hotel +
                      deposit_type + adr +total_of_special_requests, data = mydataset , family = "binomial")

summary(logistic_model)
```

Summary returneaza erorile standard, z-score, estimarile si p-values pentru fiecare dintre coeficienti. Conform rezultatelor, toti coeficientii, cu exceptia unuia singur, sunt semnificativi. 
Avem informatii si despre null deviance(deviance pentru mean) si residual deviance(deviance pentru modelul cu toti predictorii)

Urmatorul pas este de a face predictii. 


```{r}
mydataset$predict<-predict(logistic_model,type="response")
mydataset$predict[1:6]
```

Vom obtine un vector de probabilitati. Primele doua probabilitati sunt mai mari, masurand aproximativ 50% si respectiv 88%.

Vom calcula acuratetea modelului si vom incerca sa prezicem daca rezervarile vor fi anulate sau nu, pe baza variabilelor alese ca predictori.
Pentru a face asta, vom folosi o comanda ifelse, iar ca prag vom face o medie. 

```{r}
p=mean(mydataset$is_canceled)
p

 mydataset$predictions<-ifelse(mydataset$predict >p,1,0)
```

+ mydataset predictions este un vector de valori true si false. Daca mydataset predict este mai mare decat p, mydataset predictions ia valoarea 1, altfel ia valoarea 0. 


![Confusion matrix](https://miro.medium.com/max/712/1*Z54JgbS4DUwWSknhDCvNTQ.png)

TP=true positive
TN=true negative
FP=false positive
FN=false negative 

```{r}
table(mydataset$predictions,mydataset$is_canceled)
mean(mydataset$is_canceled == mydataset$predictions)
```

Acuratetea modelului este de aproximativ 75%.
Conform confusion matrix, modelul a prezis corect ca 62233 de rezervari nu vor fi anulate, dar a clasificat gresit 17077 de rezervari.
Prin analogie, modelul a prezis gresit 12933 rezervari si a clasificat corect 27147 rezervari ca fiind anulate. 


Ca ultim pas vom analiza parametri AUC si ROC.
AUC= area under curve
ROC= receiver operating characteristics
Acesti parametri sunt utilizati pentru a evalua performanta modelului de clasificare.
AUC ne poate spune cat de mult modelul este capabil sa distinga intre clase. Cu cat acesta este mai mare, cu atat modelul este mai bun in a prezice daca rezultatul va fi 1 sau 0.

```{r}

install.packages("pROC",repos = "http://cran.us.r-project.org")
library(pROC)

ROC <- roc(mydataset$is_canceled , mydataset$predictions)
plot(ROC, col = 'blue', main = "ROC curve to hotel booking model")
```

Aria de sub curba ROC se numeste AUC si este calculata astfel:
```{r}
auc(ROC)
```
AUC are o valoare apropiata de 1, ceea ce inseamna ca avem un model de predictie bun.
